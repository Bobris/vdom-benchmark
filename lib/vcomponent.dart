library vdom_benchmark.vcomponent;

import 'dart:html' as html;
import 'package:vdom_benchmark/benchmark.dart';
import 'package:vdom_benchmark/generator.dart' as g;
import 'package:vdom/vdom.dart' as v;
import 'package:vcomponent/vcomponent.dart' as vc;

class NodeComponent extends vc.Component {
  g.Node _node;

  NodeComponent(vc.Component parent, this._node) :
    super(parent, new html.DivElement());

  void updateProperties(g.Node node) {
    _node = node;
    if (_node.dirty) {
      invalidate();
    }
  }

  /// Should be auto-generated by pub transformer
  static vc.VComponent virtual(Object key, vc.Component parent, g.Node node) {
    return new vc.VComponent(key, (component) {
      if (component == null) {
        return new NodeComponent(parent, node);
      } else {
        component.updateProperties(node);
        return component;
      }
    });
  }

  List<v.Node> build() {
    final result = [];
    final children = _node.children;
    if (children != null) {
      for (var i = 0; i < children.length; i++) {
        final c = children[i];
        if (c.children == null) {
          result.add(LeafComponent.virtual(c.key, this, c));
        } else {
          result.add(NodeComponent.virtual(c.key, this, c));
        }
      }
    }
    return result;
  }

  String toString() => 'Node: [$_node]';
}

class LeafComponent extends vc.Component {
  g.Node _node;

  LeafComponent(vc.Component parent, this._node) : super(parent, new html.SpanElement());

  void updateProperties(g.Node node) {
    _node = node;
    if (_node.dirty) {
      invalidate();
    }
  }

  /// Should be auto-generated by pub transformer
  static vc.VComponent virtual(Object key, vc.Component parent, g.Node node) {
    return new vc.VComponent(key, (component) {
      if (component == null) {
        return new LeafComponent(parent, node);
      } else {
        component.updateProperties(node);
        return component;
      }
    });
  }

  List<v.Node> build() {
    return [new v.Text(0, _node.key.toString())];
  }

  String toString() => 'Leaf: [${_node.key}]';
}


class Benchmark extends BenchmarkBase {
  List<g.Node> a;
  List<g.Node> b;
  html.Element _container;

  vc.VComponent _vComponent;
  html.Element _root;

  Benchmark(this.a, this.b, this._container) : super('VComponent');

  void render() {
    _vComponent = NodeComponent.virtual(0, null, new g.Node(0, false, this.a));
    _root = _vComponent.render();
    _container.append(_root);
  }

  void update() {
    final newVComponent = NodeComponent.virtual(0, null, new g.Node(0, true, this.b));

    _vComponent.diff(newVComponent);
    vc.update();
  }

  void setup() {
  }

  void teardown() {
    _root.remove();
  }
}